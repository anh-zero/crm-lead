<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/Lead.css">
    <link rel="stylesheet" href="/css/table.css">
    <link href="/font/css/all.min.css" rel="stylesheet" />

    <!-- Nếu không tải jQuery, các hàm này sẽ không hoạt động. -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Khách hàng tiềm năng</title>
</head>

<body>
    <div class="main">
        <header>
            <!-- header__main -->
            <div class="header__main">
                <!-- header__first -->
                <div class="header__first">
                    <div class="header__first-logo">
                        <a class="header__first-logo-link" href="./home.html">
                            <img src="/image/logo.jpeg" alt="">
                        </a>
                    </div>
                    <div class="breadcrumb">
                        <a href="#" class="breadcrumb-item">CRM</a>
                        <a href="#" class="breadcrumb-item active">Khách hàng tiềm năng</a>
                    </div>
                    <!-- header__first-input -->
                    <div class="header__first-input">
                        <form class="header__first-form" action="">
                            <input class="header__first-form-input" type="text" name=""
                                placeholder="Tìm Kiếm Hoặc Gõ Lệnh (Ctrl + G)">
                            <button class="header__first-form-btn" type="submit">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- header__second -->
                <div class="header__second">
                    <ul class="header__second-list">
                        <li class="header__second-item"><i class="fa-regular fa-bell"></i></li>
                        <li class="header__second-item">|</i></li>
                        <li class="header__second-item help"><a href="#">Trợ Giúp <iclass="fas fa-chevron-down"></i></a>
                        </li>
                        <li class="header__second-item"><i class="fas fa-user-circle"></i></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- nav -->
        <nav>
            <div class="nav__main">
                <!-- nav__first -->
                <div class="nav__first">
                    <div class="nav__first-list-PC">
                        <li class="nav__first-item"><i class="fa-solid fa-bars toggle_menu"></i></li>
                        <li class="nav__first-item">
                            <span class="nav__first-item-span">KHTN</span>
                        </li>
                    </div>

                    <!-- nav_mobile -->
                    <ul class="nav__first-list-MOBILE">
                        <li class="nav__first-item"><label for="nav-mobile-input" class="fa-solid fa-bars"></label></li>
                        <li class="nav__first-item">
                            <span class="nav__first-item-span">KHTN</span>
                        </li>
                    </ul>

                    <input type="checkbox" name="" class="ohno" id="nav-mobile-input" hidden>
                    <label for="nav-mobile-input" class="overlay"></label>
                    <div class="sidebar__mobile">
                        <div class="sidebar__first">
                            <ul class="sidebar__list">
                                <li class="sidebar__title">Lọc theo</li>
                                <li class="sidebar__list-item"><a href="#">Được giao cho <i
                                            class="fa-solid fa-chevron-down"></i></a></li>
                                <li class="sidebar__list-item"><a href="#">Được tạo bởi <i
                                            class="fa-solid fa-chevron-down"></i></a> </li>
                                <li class="sidebar__title-link"><a href="#">Chỉnh sửa bộ lọc</a></li>
                                <li class="sidebar__list-item"><a href="#">Nhãn <i
                                            class="fa-solid fa-chevron-down"></i></a></li>
                                <li class="sidebar__title-link"><a href="#">Hiện nhãn</a></li>
                            </ul>
                        </div>

                        <div class="sidebar__second">
                            <ul class="sidebar__list">
                                <li>
                                <li class="sidebar__title">Lưu bộ lọc</li>
                                <li><input class="sidebar__input" type="text" name="" id="" placeholder="Tên bộ lọc">
                                </li>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- nav__second -->
                <div class="nav__second">
                    <div class="nav__second-l">
                        <button class="see-list" type="submit"><i class="fa-solid fa-list"></i> Xem Kiểu Danh Sách <i
                                class="fa-solid fa-chevron-down"></i></button>
                    </div>
                    <div class="nav__second-r">
                        <button class="reset" type="submit"><i class="fa-solid fa-rotate-right"></i></button>
                        <button class="dot" type="submit">. . .</button>
                        <input class="taochiu" type="checkbox" name="" id="vcl" hidden>
                        <button class="add-KHTN" type="submit"><a href="/add-lead">+ Thêm Khách hàng tiềm
                                năng</a></button>
                        <div class="action__insert_delete">
                            <label for="action">Hành động <i class="fa-solid fa-chevron-down"></i></label>
                            <input type="checkbox" class="ohno_b_yes" id="action" hidden>
                            <label for="action" class="overlay2"></label>
                            <ul class="action">
                                <!-- Other actions if any -->
                                <li><button type="button" onclick="editSelectedLead()">Sửa</button></li>
                                <li><button type="button" onclick="deleteSelectedLeads()">Xóa</button></li>
                                <!-- Other actions if any -->
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </nav>

        <!-- content -->
        <div class="content">
            <!-- sidebar -->
            <div class="sidebar">
                <form action="/lead" method="get">
                    <div class="sidebar__first">
                        <ul class="sidebar__list">
                            <li class="sidebar__title">Lọc theo</li>
                            <li class="sidebar__list-item"><select>
                                    <option>Được giao cho</option>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </select></li>
                            <li class="sidebar__list-item"><select>
                                    <option>Được tạo bởi</option>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </select></li>
                            <li class="sidebar__title-link"><a href="#">Chỉnh sửa bộ lọc</a></li>
                            <li class="sidebar__list-item">
                            <li class="sidebar__list-item"><select>
                                    <option>Nhãn</option>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </select></li></i></a>
                            </li>
                            <li class="sidebar__title-link"><a href="#">Hiện nhãn</a></li>
                        </ul>
                    </div>

                    <div class="sidebar__second">
                        <ul class="sidebar__list">
                            <li>
                            <li class="sidebar__title">Lưu bộ lọc</li>
                            <li><input class="sidebar__input" type="text" name="" id="" placeholder="Tên bộ lọc"></li>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>

            <!-- content__main -->
            <div class="content__main">
                <div class="c2_KHTN">


                    <!-- header -->
                    <div class="content-header">
                        <form action="/lead" method="GET">
                            <div class="content-header__first">
                                <div class="header-name">
                                    <input type="text" name="name" placeholder="Tên" value="<%= query.name || '' %>"
                                        onchange="this.form.submit()">
                                </div>
                                <div class="header-status">
                                    <select name="status" onchange="this.form.submit()">
                                        <option value="" <%=!query.status ? 'selected' : '' %>>Tất cả trạng thái
                                        </option>
                                        <option value="potential" <%=query.status==='potential' ? 'selected' : '' %>
                                            >KHTN</option>
                                        <option value="open" <%=query.status==='open' ? 'selected' : '' %>>Đang mở
                                        </option>
                                        <option value="responded" <%=query.status==='responded' ? 'selected' : '' %>>Đã
                                            phản hồi</option>
                                        <option value="opportunity" <%=query.status==='opportunity' ? 'selected' : '' %>
                                            >Cơ hội</option>
                                        <option value="quote" <%=query.status==='quote' ? 'selected' : '' %>>Báo giá
                                        </option>
                                        <option value="lost-quote" <%=query.status==='lost-quote' ? 'selected' : '' %>
                                            >Mất báo giá</option>
                                        <option value="care" <%=query.status==='care' ? 'selected' : '' %>>Quan tâm
                                        </option>
                                        <option value="convert" <%=query.status==='convert' ? 'selected' : '' %>>Chuyển
                                            đổi</option>
                                        <option value="no_contact" <%=query.status==='no_contact' ? 'selected' : '' %>
                                            >Không liên hệ</option>
                                        <!-- Add other statuses as needed -->
                                    </select>
                                </div>
                                <div class="header-title">
                                    <input type="text" name="code" placeholder="Mã số" value="<%= query.code || '' %>"
                                        onchange="this.form.submit()">
                                </div>
                            </div>

                            <div class="content-header__second">
                                <div class="header_filter">
                                    <!-- You can remove the submit button if not needed -->
                                </div>
                                <!-- Other buttons or elements -->
                            </div>
                        </form>
                    </div>
                    <div class="content-all">
                        <table class="datatable">
                            <thead>
                                <tr>
                                    <th><input id="check_all" type="checkbox"></th>
                                    <th>Tên</th>
                                    <th>Tên tổ chức</th>
                                    <th>Người sở hữu tiềm năng</th>
                                    <th>Trạng thái</th>
                                    <th>Mã số</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (dataUser && dataUser.length> 0) { %>
                                    <% for (let i=0; i < dataUser.length; i++) { %>
                                        <tr class="even_col">
                                            <td>
                                                <input class="abcd" type="checkbox" name="row-check"
                                                    value="<%= dataUser[i].id %>">
                                            </td>
                                            <td>
                                                <%= dataUser[i].name %>
                                            </td>
                                            <td>
                                                <%= dataUser[i].organization %>
                                            </td>
                                            <td>
                                                <%= dataUser[i].owner %>
                                            </td>
                                            <td>
                                                <% if (dataUser[i].status==='potential' ) { %>
                                                    Khách hàng tiềm năng
                                                    <% } else if (dataUser[i].status==='open' ) { %>
                                                        Đã mở
                                                        <% } else if (dataUser[i].status==='responded' ) { %>
                                                            Đã phản hồi
                                                            <% } else if (dataUser[i].status==='opportunity' ) { %>
                                                                Cơ hội
                                                                <% } else if (dataUser[i].status==='quote' ) { %>
                                                                    Báo giá
                                                                    <% } else if (dataUser[i].status==='lost-quote' )
                                                                        {%>
                                                                        Mất báo giá
                                                                        <% } else if (dataUser[i].status==='care' ) {%>
                                                                            Quan tâm
                                                                            <% } else if (dataUser[i].status==='convert'
                                                                                ) { %>
                                                                                Chuyển đổi
                                                                                <% } else if
                                                                                    (dataUser[i].status==='no_contact' )
                                                                                    {%>
                                                                                    Không liên hệ
                                                                                    <% } else { %>
                                                                                        <%= dataUser[i].status %>
                                                                                            <% } %>
                                            </td>
                                            <td>
                                                <%= dataUser[i].code %>
                                            </td>
                                        </tr>
                                        <% } %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="6">Không tìm thấy lead nào.</td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- script -->
    <script>
        function getSelectedLeadId() {
            const checkboxes = document.querySelectorAll('input[name="row-check"]:checked');
            if (checkboxes.length === 1) {
                return checkboxes[0].value;
            } else if (checkboxes.length === 0) {
                alert('Vui lòng chọn một khách hàng để thực hiện hành động.');
                return null;
            } else {
                alert('Chỉ chọn một khách hàng tại một thời điểm.');
                return null;
            }
        }

        function getSelectedLeadIds() {
            const checkboxes = document.querySelectorAll('input[name="row-check"]:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            if (ids.length === 0) {
                alert('Vui lòng chọn ít nhất một khách hàng để thực hiện hành động.');
                return null;
            }
            return ids;
        }

        function editSelectedLead() {
            const leadId = getSelectedLeadId();
            if (leadId) {
                window.location.href = '/edit-lead/' + leadId;
            }
        }

        function deleteSelectedLeads() {
            const ids = getSelectedLeadIds();
            if (ids) {
                if (confirm('Bạn có chắc muốn xóa các khách hàng đã chọn?')) {
                    // Send a POST request to delete the selected leads
                    fetch('/delete-leads', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Include CSRF token if needed
                        },
                        body: JSON.stringify({ ids: ids })
                    })
                        .then(response => {
                            if (response.ok) {
                                // Optionally, refresh the page or remove deleted rows from the UI
                                location.reload();
                            } else {
                                alert('Đã xảy ra lỗi khi xóa khách hàng.');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Đã xảy ra lỗi khi xóa khách hàng.');
                        });
                }
            }
        }

        $(function () {
            // Khi checkbox "#check_all" được click
            $("#check_all").on("click", function () {
                const isChecked = this.checked; // Kiểm tra trạng thái của "#check_all"
                $(".abcd[name='row-check']").prop("checked", isChecked); // Chọn/bỏ chọn tất cả checkbox với class "abcd"
                $(".taochiu").prop("checked", isChecked); // Đồng bộ chọn/bỏ chọn checkbox "taochiu"
            });

            // Khi bất kỳ checkbox nào có class "abcd" được click
            $(".abcd[name='row-check']").on("change", function () {
                const allChecked = $(".abcd[name='row-check']").length === $(".abcd[name='row-check']:checked").length;

                // Cập nhật trạng thái của "#check_all" dựa trên trạng thái của các checkbox ".abcd"
                $("#check_all").prop("checked", allChecked);

                // Cập nhật trạng thái của "taochiu" nếu có ít nhất một checkbox ".abcd" được chọn
                const isAnyChecked = $(".abcd[name='row-check']:checked").length > 0;
                $(".taochiu").prop("checked", isAnyChecked);
            });
        });

        const sidebar = document.querySelector('.sidebar');
        const toggle_menu = document.querySelector('.toggle_menu');
        const content = document.querySelector('.content__main');
        const content6 = document.querySelector('.content__main-list-shortcut');
        const content1 = document.querySelector('.one');
        const content2 = document.querySelector('.two');
        const content3 = document.querySelector('.three');
        const content4 = document.querySelector('.four');
        const content5 = document.querySelector('.five');


        toggle_menu.onclick = function () {
            sidebar.classList.toggle('hide');
            content.classList.toggle('expand');
            content1.classList.toggle('expand');
            content2.classList.toggle('expand');
            content3.classList.toggle('expand');
            content4.classList.toggle('expand');
            content5.classList.toggle('expand');
            content6.classList.toggle('expand');
        }
    </script>
</body>

</html>